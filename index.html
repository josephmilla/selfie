<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#">
  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">

    <!-- METADATA -->
    <meta name="description" content="Entry for the Challengepost Reinvent The Selfie (Powered by Twilio) Competition"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="">

    <!-- OPEN GRAPH -->
    <meta property="og:site_name" content="Selfie"/>
    <meta property="og:title" content="Selfie"/>
    <meta property="og:description" content="Entry for the Challengepost Reinvent The Selfie (Powered by Twilio) Competition"/>
    <meta property="og:image" content=""/> <!-- 1200 x 630 -->
    <meta property="og:url" content="http://josephmilla.com/selfie"/>
    <meta property="og:type" content="website"/>

    <!-- TWITTER CARD -->
    <meta name="twitter:title" content="Selfie"/>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:image" content=""/> <!-- 120 x 120 -->
    <meta name="twitter:url" content="http://josephmilla.com/selfie"/>
    <meta name="twitter:description" content="Entry for the Challengepost Reinvent The Selfie (Powered by Twilio) Competition"/>

    <!-- ICONS -->
    <link rel="image_src" href=""/>
    <link rel="shortcut icon" href=""/>
    <link rel="apple-touch-icon-precomposed" href=""/>

    <title>
      Challengepost: Reinvent The Selfie
    </title>

    <!-- FONTS -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,900">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic">

    <!-- CSS -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap-social/bootstrap-social.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">

    <style>
      * {
        -webkit-font-smoothing: antialiased;
      }

      html {
        font-family: 'Open Sans', sans-serif;
      }

      body {
        font-family: 'Open Sans', sans-serif;
        background-color: #ecf0f1;
        color: #2c3e50;
      }

      h1 {
        font-size: 48px;
        font-weight: 900;
      }

      .text-center {
        text-align: center;
      }

      .subtitle {
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 3px;
      }

      .panel-title {
        font-weight: 900;
        color: #555;
      }

      .inside-title {
        font-size: 18px;
        font-weight: 900;
        color: #2c3e50;
        display: block;
      }

      .hashtag {
        font-weight: 300;
      }

      p {
        padding-top: 15px;
        padding-bottom: 10px;
        color: #2c3e50;
      }

      .row {
        padding-top: 50px;
      }

      .gh-generated {
        margin: 20px 0;
        height: 200px !important;
        font-family: 'Consolas', monospace;
      }

      .form-elm {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border: 1px solid #bdc3c7;
        outline: none;
      }

      textarea {
        width: calc(100% - 25px);
        resize: vertical;
      }

      .btn {
        font-weight: 700;
        font-size: 11px;
      }

      .sp-input {
        font-family: 'Consolas', monospace !important;
      }

      .addon-primary {
        color: #fff;
        background-color: #337ab7;
        border-color: #2e6da4;
        cursor: pointer;
      }

      .addon-primary:hover,
      .addon-primary:focus {
        opacity: 0.75;
      }

      .addon-primary:active {
        opacity: 0.90;
      }

      .select {
        display: inline-block;
        margin: 0 auto;
      }

      video,
      canvas,
      .screenshot {
        display: block;
      }

      .screenshot {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid">
      <div class="row text-center">
        <h1>Challengepost: Reinvent The Selfie Entry</h1>
        <span class="subtitle"><small>by</small> Joseph Milla</span>
      </div>

      <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          <div class="panel panel-default">
            <!-- <div class="panel-heading">
              <h3 class="panel-title">Widget</h3>
            </div> -->

            <div class="panel-body">
              <div class="container-fluid">
                <center>
                  <div class="row">
                    <span class="inside-title">Take A Selfie!</span>
                    <span class="hashtag">#SorryNotSorry</span>
                  </div>

                  <div class="row">
                    <div id="videos-container"></div>
                  </div>

                  <div class="row">
                    <button id="start" type="button" class="btn btn-primary"  onclick="snapshot()"><span class="glyphicon glyphicon-record"></span></button>
                    <button id="stop" type="button" class="btn btn-danger"><span class="glyphicon glyphicon-stop"></span></button>
                  </div>

                  <div id="gif-container" class="row">
                  </div>
                </center>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-1"></div>
      </div>
    </div>

    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"></script>
    <script src="https://cdn.webrtc-experiment.com/gif-recorder.js"></script>
    <script type="text/javascript" src="https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js"></script>
    <script>
      var mediaConstraints = { video: true };

      navigator.getUserMedia(mediaConstraints, onMediaSuccess, onMediaError);

      document.querySelector('#stop').disabled = true;

      document.querySelector('#start').onclick = function() {
        this.disabled = true;
        document.querySelector('#stop').disabled = false;
        var timeInterval = 30000;

        // get blob after specific time interval
        mediaRecorder.start(timeInterval);
      };

      document.querySelector('#stop').onclick = function() {
        this.disabled = true;
        mediaRecorder.stop();
      };

      var mediaRecorder;
      var blobURL, dataURL, uploadURL, imgurURL;
      var phoneNumber;

      var reader  = new FileReader();

      function onMediaSuccess(stream) {
          var video = document.createElement('video');

          video = mergeProps(video, {
              controls: false,
              width: 320,
              height: 240,
              src: URL.createObjectURL(stream),
              autoplay: true
          });
          video.play();

          videosContainer.appendChild(video);

          mediaRecorder = new MediaStreamRecorder(stream);
          mediaRecorder.mimeType = 'image/gif'; // this line is mandatory
          mediaRecorder.videoWidth  = 320;
          mediaRecorder.videoHeight = 240;
          mediaRecorder.ondataavailable = function(blob) {
              blobURL = URL.createObjectURL(blob);


              var xhr = new XMLHttpRequest;
              xhr.responseType = 'blob';

              xhr.onload = function() {
                 var recoveredBlob = xhr.response;

                 var reader = new FileReader;

                 reader.onload = function() {
                  dataURL = reader.result;
                  //  window.location = blobAsDataUrl;
                  uploadURL = dataURL.replace('data:image/gif;base64,', '');
                 };

                 reader.readAsDataURL(recoveredBlob);
              };

              xhr.open('GET', blobURL);
              xhr.send();

              $('#gif-container').append('<img src="' + blobURL + '"/>');
              $('#gif-container').append('<div class="row"><div class="col-md-3"></div><div class="col-md-6"><span class="inside-title">Share Your Selfie</span><br><a class="btn btn-social-icon btn-facebook" onclick=share("facebook")><i class="fa fa-facebook"></i></a>&nbsp;<a class="btn btn-social-icon btn-twitter" onclick=share("twitter")><i class="fa fa-twitter"></i></a>&nbsp;<a class="btn btn-social-icon btn-pinterest" onclick=textMessage()><i class="glyphicon glyphicon-phone"></i></a><br><br></div><div class="col-md-3"></div></div>');
          };
      }

      function onMediaError(e) {
        console.error('Media Error', e);
      }

      function textMessage() {
        getNumber();
        share('twilio');
      }

      function getNumber() {
        phoneNumber = prompt("Please a phone number (United States)", "(XXX)-XXX-XXXX").replace("[()\\s-]+", "");
      }

      function share(site) {
        if(imgurURL) {
          if(site == 'facebook') {
            window.open('https://www.facebook.com/sharer/sharer.php?t=Selfie&u=' + imgurURL);
          } else if(site == 'twitter') {
            window.open('https://twitter.com/intent/tweet?text=Selfie&url='+ imgurURL +'&via=josephmilla');
          } else if(site == 'twilio') {
            $.ajax({
              url: 'http://45.55.134.228:8081/twilio',
              type: 'GET',
              data: {
                receiver: phoneNumber,
                url: imgurURL
              },
              success: function(result) {
                console.log("Message was sent!");
              }
            });
          }
        } else {
          $.ajax({
            url: 'https://api.imgur.com/3/image',
            type: 'POST',
            headers: {
              Authorization: 'Client-ID d40b60584afc371',
              Accept: 'application/json'
            },
            data: {
              image: uploadURL,
              type: 'base64'
            },
            success: function(result) {
              var id = result.data.id;
              // window.location = 'https://imgur.com/gallery/' + id;
              imgurURL = 'http://i.imgur.com/'+ id + '.gif';
              if(site == 'facebook') {
                // window.open('https://www.facebook.com/sharer/sharer.php?t=Selfie&u=' + imgurURL);
                window.open('https://www.facebook.com/dialog/share?app_id=145634995501895&display=popup&href=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2F&redirect_uri=https%3A%2F%2Fdevelopers.facebook.com%2Ftools%2Fexplorer')
              } else if(site == 'twitter') {
                window.open('https://twitter.com/intent/tweet?text=Selfie&url='+ imgurURL +'&via=josephmilla&hashtags=SorryNotSorry,ChallengePost,SummerJam');
              } else if(site == 'twilio') {
                $.ajax({
                  url: 'http://45.55.134.228:8081/twilio',
                  type: 'GET',
                  data: {
                    receiver: phoneNumber,
                    url: imgurURL
                  },
                  success: function(result) {
                    console.log("Message was sent!");
                  }
                });
              }
            }
          });
        }
      }

      var videosContainer = document.getElementById('videos-container');
      var index = 1;

      window.onbeforeunload = function() {
        document.querySelector('#start').disabled = false;
      };
    </script>
  </body>
</html>
